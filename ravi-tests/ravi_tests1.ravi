local z,x,y

-- test 1 
z = function(a)
  print(a)
  return a+1
end
x = function(f)
  local j = 5
  j = f(j)
  return j
end

assert(ravi.compile(x))
assert(x(z) == 6)
print("test 1 OK")

-- test 2
z = function (a,p)
  p(a)
  return 6
end

x = function (yy,p)
  local j = 5
  j = yy(j,p)
  return j
end

assert(ravi.compile(z))
assert(ravi.compile(x))
assert(x(z,print) == 6)
print("test 2 OK")

-- test 3
x = function () 
  local i, j:integer
  j=0
  for i=1,1000000000 do
  	j = j+1
  end
  return j
end

assert(ravi.compile(x))
assert(x() == 1000000000)
print("test 3 OK")

-- test 4
x = function ()
  local j:number
  for i=1,1000000000 do
    j = j+1
  end
  return j
end

assert(ravi.compile(x))
assert(x() == 1000000000.0)
print("test 4 OK")

-- test 5
x = function ()
  local j = 0
  for i=2,6,3 do
    j = i
  end
  return j
end

assert(ravi.compile(x))
assert(x() == 5)
print("test 5 OK")

-- test 6
x = function ()
  local j = 0
  for i=2.0,6.0,3.1 do
    j = i
  end
  return j
end

assert(ravi.compile(x))
assert(x() == 5.1)
print("test 6 OK")

-- test 7
x = function ()
  local a=5
  return 1004,2
end

assert(ravi.compile(x))
assert(x() == 1004)
print("test 7 OK")

-- test 8
x = function ()
  if 1 == 2 then
    return 5.0
  end
  return 1.0
end

assert(ravi.compile(x))
assert(x() == 1.0)
print("test 8 OK")

-- test 9
x = function (y)
  if y == 1 then
    return 1.0
  elseif y == 5 then
    return 2.0
  else
    return 3.0
  end
end
assert(ravi.compile(x))
assert(x(5) == 2.0)
assert(x(4) == 3.0)
print("test 9 OK")

-- test 10
x = function (y,z)
  if y == 1 then
    if z == 1 then
      return 99.0
    else
      return z
    end
  elseif y == 5 then
    return 2.0
  else
    return 3.0
  end
end

assert(ravi.compile(x))
assert(x(1,1) == 99.0)
assert(x(1,2) == 2)
assert(x(1,5.3) == 5.3)
assert(x(5) == 2.0)
assert(x(4) == 3.0)
print("test 10 OK")

-- test 11
function tryme()
  local i,j = 5,6
  return i,j
end
assert(ravi.compile(tryme))
local i:integer, j:integer = tryme(); assert(i+j == 11)
print("test 11 OK")

-- test 12
function tryme()
  local a : number[], j:number = {}
  for i=1,10 do
    a[i] = i
    j = j + a[i]
  end
  return j
end
-- assert(ravi.compile(tryme)) 
assert(tryme() == 55.0)
print("test 12 OK")

-- test 13
function pisum()
    local sum : number
    for j = 1,500 do
        sum = 0.0
        for k = 1,10000 do
            sum = sum + 1.0/(k*k)
        end
    end
    return sum
end
assert(ravi.compile(pisum))
assert(math.abs(pisum()-1.644834071848065) < 1e-12)
print("test 13 OK")

-- test 14
function tryme()
  local i,j = 5,6
  return i,j
end
function x(f)
  local i:integer, j:integer = f()
  return i+j
end
assert(ravi.compile(tryme))
assert(ravi.compile(x))
assert(x(tryme) == 11)
print("test 14 OK")

-- test 15
function tryme()
  local i,j = 5.1,"6.2"
  return i,j
end
function x(f)
  local i:number, j:number = f()
  return i+j
end
assert(ravi.compile(tryme))
assert(ravi.compile(x))
assert(x(tryme) == 11.3)
print("test 15 OK")

-- test 16
function tryme(x,y)
  if x < y then
    return 1
  else
    return 0
  end
end
--ravi.dumplua(tryme)
assert(ravi.compile(tryme))
assert(tryme(1,2) == 1)
assert(tryme(2,1) == 0)
print("test 16 OK")

-- test 17
function tryme(x,y)
  return x < y
end
--ravi.dumplua(tryme)
assert(ravi.compile(tryme))
assert(tryme(1,2))
assert(not tryme(2,1))
print("test 17 OK")

-- test 18
function tabtest(x)
  x[1] = 5
  return x[1]
end
--ravi.dumplua(tabtest)
assert(ravi.compile(tabtest))
--ravi.dumpllvm(tabtest)
assert(tabtest({}) == 5)
print("test 18 OK")

-- test 19
function optest()
  local a,b,c = 1, 5
  c = a and b
  return c
end
-- ravi.dumplua(optest)
assert(ravi.compile(optest))
-- ravi.dumpllvm(optest)
assert(optest() == 5)
print("test 19 OK")

-- test 20
function optest()
  local a,b,c = 1, 5
  c = a or b
  return c
end
-- ravi.dumplua(optest)
assert(ravi.compile(optest))
-- ravi.dumpllvm(optest)
assert(optest() == 1)
print("test 20 OK")

-- test 21
function optest()
  local a,b = 1, 5
  if a and b then
    return b
  end
  return a
end
-- ravi.dumplua(optest)
assert(ravi.compile(optest))
-- ravi.dumpllvm(optest)
assert(optest() == 5)
print("test 21 OK")

-- test 22
function optest()
  local a,b = nil, 5
  if a or b then
    return b
  end
  return a
end
-- ravi.dumplua(optest)
assert(ravi.compile(optest))
-- ravi.dumpllvm(optest)
assert(optest() == 5)
print("test 22 OK")

-- test 23
function testadd(a,b)
  return a+b
end
assert(ravi.compile(testadd))
assert(testadd(1,1) == 2)
assert(testadd(1.5,1.6) == 3.1)
assert(testadd("1.5",1.6) == 3.1)
assert(testadd("1.5","1.6") == 3.1)
print("test 23 OK")

-- test 24
function testsub(a,b)
  return a-b
end
assert(ravi.compile(testsub))
assert(testsub(1,1) == 0)
assert(math.abs(testsub(1.5,1.6)-(-0.1)) < 1e-12)
assert(math.abs(testsub("1.5",1.6)-(-0.1)) < 1e-12)
assert(math.abs(testsub("1.5","1.6")-(-0.1)) < 1e-12)
print("test 24 OK")

-- test 25
function testmul(a,b)
  return a*b
end
assert(ravi.compile(testmul))
assert(testmul(2,2) == 4)
assert(math.abs(testmul(1.5,1.6)-2.4) < 1e-12)
assert(math.abs(testmul("1.5",1.6)-2.4) < 1e-12)
assert(math.abs(testmul("1.5","1.6")-2.4) < 1e-12)
print("test 25 OK")


-- test 26
function testdiv(a,b)
  return a/b
end
assert(ravi.compile(testdiv))
assert(testdiv(2,2) == 1.0)
assert(math.abs(testdiv(1.5,1.6)-0.9375) < 1e-12)
assert(math.abs(testdiv("1.5",1.6)-0.9375) < 1e-12)
assert(math.abs(testdiv("1.5","1.6")-0.9375) < 1e-12)
print("test 26 OK")
